<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0">
  <meta charset="utf-8">
  <title>chat room</title>
  <link href="https://fonts.googleapis.com/css?family=Supermercado+One" rel="stylesheet">
  <link rel="stylesheet" href="stylesheet.css">
</head>

<body>
  <header>
    <p>chat</p>
  </header>
  <div class="main-container">
    <template id="chat-template">
      <div class="message">
        <div class="message-icon"></div>
        <div class="message-main">
          <div class="mm-name">てすとまん</div>
          <span class="mm-text" contenteditable="true">うあああーーああああああああああああああああああああああ</span>
          <span class="mm-time">18:35</span>
        </div>
      </div>
      <br>
    </template>
  </div>

  <div class="input">
    <span class="main">
      <span class="main-text" contenteditable="true"><p><br></p></span>
    <span class="main-emoji"></span>
    </span>
    <span class="input-send"></span>
  </div>
</body>

<script>
  const ws = new WebSocket('ws://localhost:8080/');
  // const ws = new WebSocket('wss://node-chat-tmasaaa.glitch.me');

  // chat text-message
  const text_input = document.querySelector('.main-text');
  text_input.addEventListener('keydown', e => {
    if (e.key === 'Backspace') {
      if (text_input.innerHTML === '<p><br></p>') {
        e.preventDefault();
      }
    }
  });

  const main_text = document.querySelector('.main-text');
  // IP識別して、IPごとにID割り振ろう？
  const userID = Math.random().toString(36).slice(-4);
  // post
  const post = () => {
    const message = main_text.innerHTML;
    const val = {
      id: userID,
      color: '',
      msg: message
    };
    ws.send(JSON.stringify(val));
    main_text.innerText = '';
  };
  // send button post
  document.querySelector('.input-send').addEventListener('click', e => {
    post();
  });

  ws.onopen = e => {
    // msgInput.focus();
  };

  ws.onmessage = e => {
    const T = document.querySelector('#chat-template').content;
    let MSG = JSON.parse(e.data);
    let ID = JSON.parse(e.data).id;
    const D = new Date();

    T.querySelector('.mm-text').innerHTML = MSG.msg;
    T.querySelector('.mm-name').innerText = MSG.id;
    T.querySelector('.mm-time').innerText = `${D.getHours()}:${D.getMinutes()}`;
    const CLONE = document.importNode(T, true);
    document.querySelector('.main-container').appendChild(CLONE);
    console.log(MSG);

    scrollTo(0, document.body.scrollHeight);
  };
</script>

</html>
