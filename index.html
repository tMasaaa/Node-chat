<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>chat room</title>
  <link href="https://fonts.googleapis.com/css?family=Supermercado+One" rel="stylesheet">
  <link rel="stylesheet" href="stylesheet.css">
</head>

<body>
  <header>
    <p>chat</p>
  </header>
  <div class="input">
    <form action="javascript:post();" method="post" name="F">
      <input name="text" class="msg-input" type="textarea" required>
      <input type="submit" value="GO">
    </form>
  </div>
  <div class="main-container">
    <template id="chat-template">
      <div class="content">
        <div class="message">
          <div class="icon"></div>
          <div class="main">
            <div class="message-name">test man</div>
            <span class="message-text"></span>
            <span class="message-time">18:35</span>
          </div>
        </div>
      </div>
      <br>
    </template>
  </div>
</body>

<script>
const ws = new WebSocket('ws://localhost:8080/');
// const ws = new WebSocket('wss://node-chat-tmasaaa.glitch.me');

  const msgInput = document.querySelector('.msg-input');
  // IP識別して、IPごとにID割り振ろう？
  const userID = Math.random().toString(36).slice(-4);
  // post
  const post = () => {
    const message = document.forms.F.text.value;
    const val = {
      id: userID,
      color: '',
      msg: message
    };
    ws.send(JSON.stringify(val));
    msgInput.value = '';
  };
  // Enter key post
  msgInput.addEventListener('keypress', e => {
    if (e.keyCode === 13 && msgInput.value !== '') {
      post();
    }
  });

  ws.onopen = e => {
    msgInput.focus();
  };

  ws.onmessage = e => {
    const T = document.querySelector('#chat-template').content;
    let MSG = JSON.parse(e.data);
    let ID = JSON.parse(e.data).id;
    const D = new Date();

    T.querySelector('.message-text').innerText = MSG.msg;
    T.querySelector('.message-name').innerText = MSG.id;
    T.querySelector('.message-time').innerText = `${D.getHours()}:${D.getMinutes()}`;
    const CLONE = document.importNode(T, true);
    document.querySelector('.main-container').appendChild(CLONE);
    console.log(MSG);

    scrollTo(0, document.body.scrollHeight);
  };

</script>

</html>
